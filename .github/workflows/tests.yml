name: brew test-bot

on:
  pull_request:

jobs:
  test-bot:
    runs-on: services-k8s-amd64
    container:
      image: registry.services.helixer.io/ghcr-io/homebrew/ubuntu22.04:latest
    steps:
      - name: Setup tap
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GH_TOKEN_HOMEBREW }}
        run: |
          # K8s hook-extension forces root â€” Homebrew refuses root, so
          # use the pre-existing linuxbrew user from the Homebrew image.
          HOMEBREW=/home/linuxbrew/.linuxbrew/Homebrew
          REPO="${{ github.repository }}"
          TAP_DIR="$HOMEBREW/Library/Taps/$(echo "$REPO" | tr '[:upper:]' '[:lower:]')"

          # Git credentials for private repo access
          sudo -u linuxbrew git config --global credential.helper store
          sudo -u linuxbrew bash -c "echo 'https://x-access-token:${HOMEBREW_GITHUB_API_TOKEN}@github.com' > /home/linuxbrew/.git-credentials"

          # Clone the tap with main and PR branches so test-bot can diff
          sudo -u linuxbrew mkdir -p "$TAP_DIR"
          sudo -u linuxbrew git -C "$TAP_DIR" init
          sudo -u linuxbrew git -C "$TAP_DIR" remote add origin "https://github.com/$REPO"
          sudo -u linuxbrew git -C "$TAP_DIR" fetch origin '+refs/heads/*:refs/remotes/origin/*'
          sudo -u linuxbrew git -C "$TAP_DIR" remote set-head origin --auto
          sudo -u linuxbrew git -C "$TAP_DIR" checkout --force -B '${{ github.event.pull_request.head.ref }}' 'origin/${{ github.event.pull_request.head.ref }}'

          # Write env file so each step can source it with sudo
          cat > /tmp/brew-env.sh << 'BREWEOF'
          export PATH="/home/linuxbrew/.linuxbrew/bin:$PATH"
          BREWEOF
          {
            echo "export HOMEBREW_GITHUB_API_TOKEN=\"$HOMEBREW_GITHUB_API_TOKEN\""
            echo "export HOMEBREW_NO_AUTO_UPDATE=1"
            echo "export GITHUB_ACTIONS=\"${GITHUB_ACTIONS:-}\""
            echo "export GITHUB_BASE_REF=\"${GITHUB_BASE_REF:-}\""
            echo "export GITHUB_EVENT_NAME=\"${GITHUB_EVENT_NAME:-}\""
            echo "export GITHUB_EVENT_PATH=\"${GITHUB_EVENT_PATH:-}\""
            echo "export GITHUB_OUTPUT=\"${GITHUB_OUTPUT:-}\""
            echo "export GITHUB_REF=\"${GITHUB_REF:-}\""
            echo "export GITHUB_REPOSITORY=\"${GITHUB_REPOSITORY:-}\""
            echo "export GITHUB_SHA=\"${GITHUB_SHA:-}\""
            echo "export GITHUB_STEP_SUMMARY=\"${GITHUB_STEP_SUMMARY:-}\""
            echo "export GITHUB_WORKSPACE=\"${GITHUB_WORKSPACE:-}\""
            echo "export RUNNER_TEMP=\"${RUNNER_TEMP:-}\""
            echo "export RUNNER_OS=\"${RUNNER_OS:-}\""
          } >> /tmp/brew-env.sh

          # test-bot writes steps_output.txt and bottles to $GITHUB_WORKSPACE
          chown -R linuxbrew:linuxbrew "$GITHUB_WORKSPACE"

      - run: sudo -H -u linuxbrew bash -c "source /tmp/brew-env.sh && cd $GITHUB_WORKSPACE && brew test-bot --only-cleanup-before"
      - run: sudo -H -u linuxbrew bash -c "source /tmp/brew-env.sh && cd $GITHUB_WORKSPACE && brew test-bot --only-tap-syntax"

      - name: brew test-bot --only-formulae
        run: sudo -H -u linuxbrew bash -c "source /tmp/brew-env.sh && cd $GITHUB_WORKSPACE && brew test-bot --only-formulae"

      - name: Upload bottles as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bottles
          path: '*.bottle.*'
          if-no-files-found: ignore
