name: brew test

on:
  pull_request:

jobs:
  test:
    runs-on: leafblower-k8s-amd64
    container:
      image: registry.services.helixer.io/ghcr-io/homebrew/ubuntu22.04:latest
    steps:
      - name: Setup tap
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GH_TOKEN_HOMEBREW }}
        run: |
          HOMEBREW=/home/linuxbrew/.linuxbrew/Homebrew
          REPO="${{ github.repository }}"
          TAP_DIR="$HOMEBREW/Library/Taps/$(echo "$REPO" | tr '[:upper:]' '[:lower:]')"

          sudo -u linuxbrew git config --global credential.helper store
          sudo -u linuxbrew bash -c "echo 'https://x-access-token:${HOMEBREW_GITHUB_API_TOKEN}@github.com' > /home/linuxbrew/.git-credentials"

          sudo -u linuxbrew mkdir -p "$TAP_DIR"
          sudo -u linuxbrew git -C "$TAP_DIR" init
          sudo -u linuxbrew git -C "$TAP_DIR" remote add origin "https://github.com/$REPO"
          sudo -u linuxbrew git -C "$TAP_DIR" fetch origin '+refs/heads/*:refs/remotes/origin/*'
          sudo -u linuxbrew git -C "$TAP_DIR" remote set-head origin --auto
          sudo -u linuxbrew git -C "$TAP_DIR" checkout --force -B '${{ github.event.pull_request.head.ref }}' 'origin/${{ github.event.pull_request.head.ref }}'

          # Detect changed formulae from the PR
          CHANGED=$(curl -sf \
            -H "Authorization: token ${{ github.token }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" \
            | grep -oE '"filename" *: *"Formula/[^"]*\.rb"' \
            | sed 's|.*"Formula/||;s|\.rb"||' \
            | tr '\n' ' ')
          echo "Detected changed formulae: $CHANGED"

          TAP_NAME="$(echo "$REPO" | sed 's|/homebrew-|/|')"

          cat > /tmp/brew-env.sh << BREWEOF
          export PATH="/home/linuxbrew/.linuxbrew/bin:\$PATH"
          export TAP_NAME="$TAP_NAME"
          export CHANGED_FORMULAE="$CHANGED"
          export HOMEBREW_GITHUB_API_TOKEN="$HOMEBREW_GITHUB_API_TOKEN"
          export HOMEBREW_NO_AUTO_UPDATE=1
          BREWEOF

      - name: Install, test, audit
        run: |
          sudo -H -u linuxbrew bash -c '
            source /tmp/brew-env.sh
            for f in $CHANGED_FORMULAE; do
              FORMULA="$TAP_NAME/$f"
              echo "==> brew install --build-from-source $FORMULA"
              brew install --build-from-source "$FORMULA"
              echo "==> brew test $FORMULA"
              brew test "$FORMULA"
              echo "==> brew audit --formula $FORMULA"
              brew audit --formula "$FORMULA"
            done
          '
