name: brew publish

on:
  pull_request_target:
    types:
      - labeled

jobs:
  publish:
    if: contains(github.event.pull_request.labels.*.name, 'publish')
    runs-on: services-k8s-amd64
    container:
      image: registry.services.helixer.io/ghcr-io/homebrew/ubuntu22.04:latest
    steps:
      - name: Setup git
        env:
          TOKEN: ${{ secrets.GH_TOKEN_HOMEBREW }}
        run: |
          sudo -u linuxbrew git config --global credential.helper store
          sudo -u linuxbrew bash -c "echo 'https://x-access-token:${TOKEN}@github.com' > /home/linuxbrew/.git-credentials"
          sudo -u linuxbrew git config --global user.name "BrewTestBot"
          sudo -u linuxbrew git config --global user.email "homebrew-test-bot@lists.sfconservancy.org"

      - name: Checkout and merge PR
        env:
          TOKEN: ${{ secrets.GH_TOKEN_HOMEBREW }}
        run: |
          TAP_DIR=/home/linuxbrew/.linuxbrew/Homebrew/Library/Taps/helixerio/homebrew-brews
          mkdir -p "$(dirname "$TAP_DIR")"

          sudo -u linuxbrew git clone "https://x-access-token:${TOKEN}@github.com/${{ github.repository }}" "$TAP_DIR"
          cd "$TAP_DIR"
          sudo -u linuxbrew git checkout main

          # Merge the PR branch
          sudo -u linuxbrew git merge "origin/${{ github.event.pull_request.head.ref }}" --no-edit

          # Push to main
          sudo -u linuxbrew git push origin main

      - name: Delete branch
        if: github.event.pull_request.head.repo.fork == false
        env:
          TOKEN: ${{ secrets.GH_TOKEN_HOMEBREW }}
        run: |
          TAP_DIR=/home/linuxbrew/.linuxbrew/Homebrew/Library/Taps/helixerio/homebrew-brews
          cd "$TAP_DIR"
          sudo -u linuxbrew git push origin --delete "${{ github.event.pull_request.head.ref }}"
