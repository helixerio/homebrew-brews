name: brew publish

on:
  pull_request_target:
    types:
      - labeled

jobs:
  publish:
    if: contains(github.event.pull_request.labels.*.name, 'publish')
    runs-on: services-k8s-amd64
    container:
      image: registry.services.helixer.io/ghcr-io/homebrew/ubuntu22.04:latest
    steps:
      - name: Setup git
        env:
          TOKEN: ${{ secrets.GH_TOKEN_HOMEBREW }}
        run: |
          sudo -u linuxbrew git config --global credential.helper store
          sudo -u linuxbrew bash -c "echo 'https://x-access-token:${TOKEN}@github.com' > /home/linuxbrew/.git-credentials"
          sudo -u linuxbrew git config --global user.name "BrewTestBot"
          sudo -u linuxbrew git config --global user.email "homebrew-test-bot@lists.sfconservancy.org"

      - name: Setup tap
        env:
          TOKEN: ${{ secrets.GH_TOKEN_HOMEBREW }}
        run: |
          TAP_DIR=/home/linuxbrew/.linuxbrew/Homebrew/Library/Taps/helixerio/homebrew-brews
          sudo -u linuxbrew mkdir -p "$(dirname "$TAP_DIR")"
          sudo -u linuxbrew git clone "https://x-access-token:${TOKEN}@github.com/${{ github.repository }}" "$TAP_DIR"

      - name: Pull bottles
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GH_TOKEN_HOMEBREW }}
          HOMEBREW_NO_AUTO_UPDATE: 1
        run: |
          TAP_DIR=/home/linuxbrew/.linuxbrew/Homebrew/Library/Taps/helixerio/homebrew-brews

          # Ensure GITHUB_OUTPUT is writable by linuxbrew
          chmod 666 "$GITHUB_OUTPUT"

          sudo -H -u linuxbrew bash -c "
            export PATH=/home/linuxbrew/.linuxbrew/bin:\$PATH
            export HOMEBREW_GITHUB_API_TOKEN=$HOMEBREW_GITHUB_API_TOKEN
            export HOMEBREW_NO_AUTO_UPDATE=1
            export GITHUB_ACTIONS=$GITHUB_ACTIONS
            export GITHUB_OUTPUT=$GITHUB_OUTPUT
            cd $TAP_DIR
            brew pr-pull --debug --no-upload --retain-bottle-dir --tap=${{ github.repository }} --workflows=bottle.yml ${{ github.event.pull_request.number }}
          "

          # Export bottle_path for subsequent steps
          BOTTLE_DIR=$(grep '^bottle_path=' "$GITHUB_OUTPUT" | tail -1 | cut -d= -f2-)
          echo "BOTTLE_DIR=$BOTTLE_DIR" >> "$GITHUB_ENV"

      - name: Create bottle commit
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GH_TOKEN_HOMEBREW }}
          HOMEBREW_NO_AUTO_UPDATE: 1
        run: |
          sudo -H -u linuxbrew bash -c "
            export PATH=/home/linuxbrew/.linuxbrew/bin:\$PATH
            export HOMEBREW_GITHUB_API_TOKEN=$HOMEBREW_GITHUB_API_TOKEN
            export HOMEBREW_NO_AUTO_UPDATE=1
            cd $BOTTLE_DIR
            brew bottle --merge --write *.bottle.json
          "

      - name: Push commits
        run: |
          TAP_DIR=/home/linuxbrew/.linuxbrew/Homebrew/Library/Taps/helixerio/homebrew-brews
          cd "$TAP_DIR"
          sudo -u linuxbrew git push origin main

      - name: Upload bottles
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GH_TOKEN_HOMEBREW }}
          HOMEBREW_NO_AUTO_UPDATE: 1
        run: |
          sudo -H -u linuxbrew bash -c "
            export PATH=/home/linuxbrew/.linuxbrew/bin:\$PATH
            export HOMEBREW_GITHUB_API_TOKEN=$HOMEBREW_GITHUB_API_TOKEN
            export HOMEBREW_NO_AUTO_UPDATE=1
            cd $BOTTLE_DIR
            brew pr-upload --debug --upload-only
          "

      - name: Delete branch
        if: github.event.pull_request.head.repo.fork == false
        run: |
          TAP_DIR=/home/linuxbrew/.linuxbrew/Homebrew/Library/Taps/helixerio/homebrew-brews
          cd "$TAP_DIR"
          sudo -u linuxbrew git push origin --delete "${{ github.event.pull_request.head.ref }}"
